<html>
<head>
<script src="prototype-1.6.0.2.js"></script>
</head>
<body style="padding:0px; margin:0px; background-color: black; color: yellow;">

<div id="mediaHost">
</div>

<div style="float:right">
   <!--div id="controls" style="float:right">
      <a href="#" onClick="nextEvent(); return false;">next</a><br/>
   </div-->
   <div id="output" style="float:right">
   </div>
</div>

<script>
function clearMediaHost()
{
  $('mediaHost').innerHTML = '';
}

function stopMedia( id )
{
   var removedElement = $('mediaHost').removeChild( document.getElementById(id) );
   $('output').innerHTML += 'stopMedia '+id+' '+
      eventTags[currentEventId].getAttribute('date')+' '+
      eventTags[currentEventId].getAttribute('time')+'<br/>';
}

function startMedia( id,url,date,time,x,y,width,height )
{
  var elEmbed = document.createElement( 'embed' );
  
  elEmbed.id = id;

  elEmbed.src = url;

  elEmbed.style.position = "absolute";
  elEmbed.style.left = x;
  elEmbed.style.top = y;
  elEmbed.width = width;
  elEmbed.height = height;

  elEmbed.setAttribute('autoplay','true');
  elEmbed.setAttribute('controller','false');
  
   $('output').innerHTML += 'startMedia '+id+':'+x+'x'+y+':'+width+'x'+height+':'+url+' '+
      eventTags[currentEventId].getAttribute('date')+' '+
      eventTags[currentEventId].getAttribute('time')+'-'+
      eventTags[currentEventId].getAttribute('end_time')+'<br/>';
   $('mediaHost').appendChild( elEmbed );
}

function nextEvent()
{
   var today = new Date();
   var p_today = Date.parse(today)+time_adjustment;

   var dateParts = eventTags[currentEventId].getAttribute('date').split("-");
   var DD = dateParts[0];
   var MM = dateParts[1];
   var YYYY = dateParts[2];
   var timeParts = eventTags[currentEventId].getAttribute('time').split(":");
   var HH = timeParts[0];
   var MI = timeParts[1];
   var SS = timeParts[2];
   var eventDateTime = new Date(YYYY,MM-1,DD,HH,MI,SS);
   var p_eventDateTime = Date.parse(eventDateTime);

   var delay = p_eventDateTime - p_today; // in milliseconds

   var id = eventTags[currentEventId].getAttribute('related_id');

   var eventName = eventTags[currentEventId].getAttribute('event');
   
   if( eventName == 'start media' )
   {
      var date = eventTags[currentEventId].getAttribute('date');
      var time = eventTags[currentEventId].getAttribute('time');
      var x = eventTags[currentEventId].getAttribute('position_x');
      var y = eventTags[currentEventId].getAttribute('position_y');
      var width = eventTags[currentEventId].getAttribute('width');
      var height = eventTags[currentEventId].getAttribute('height');
      var related_name = eventTags[currentEventId].getAttribute('related_name');
      var url = width+'x'+height+'/'+related_name;
      setTimeout( "startMedia( '"+id+"','"+url+"','"+date+"','"+time+"',"+x+","+y+","+width+","+height+" )", delay );
   }
   else if( eventName == 'stop media' )
   {
      setTimeout( "stopMedia( '"+id+"' )", delay );
   }

   currentEventId++;
   setTimeout( "nextEvent()", delay );
}



// it will take considerable amount of time to load the playlist
$('output').innerHTML += 'Loading events';
new Ajax.Request( 'playlistevents.xml', { 
  method: 'get',
  onSuccess: function( transport ) {
    eventTags = transport.responseXML.getElementsByTagName( 'event' );
  }
} );


var currentEventId = 0;
var eventTags;

var time_adjustment=0;//32400000; // for debugging purposes

setTimeout( "init()", 1000 );

function init()
{
   try
   {
      $('output').innerHTML += ' ' + eventTags.length;
   }
   catch(err) 
   {
      $('output').innerHTML += ' .';
      setTimeout( "init()", 1000 );
      return false;
   }
   $('output').innerHTML += ' events loaded.<br/>';
   skipTime();
}


function skipTime()
{
   var today = new Date();
   var p_today = Date.parse(today)+time_adjustment;

   // This loop will skip through array of events to current moment in time.
   //TODO: protect against infinite loop
   while (true)
   {
      if( eventTags[currentEventId].getAttribute('event') != 'start media' )
      {
         currentEventId++;
         continue;
      }

      var dateParts = eventTags[currentEventId].getAttribute('date').split("-");
      var DD = dateParts[0];
      var MM = dateParts[1];
      var YYYY = dateParts[2];

      var timeParts = eventTags[currentEventId].getAttribute('time').split(":");
      var HH = timeParts[0];
      var MI = timeParts[1];
      var SS = timeParts[2];
      var eventDateTime = new Date(YYYY,MM-1,DD,HH,MI,SS);
      var p_eventDateTime = Date.parse(eventDateTime);

      var endTimeParts = eventTags[currentEventId].getAttribute('end_time').split(":");
      var HH = endTimeParts[0];
      var MI = endTimeParts[1];
      var SS = endTimeParts[2];
      var eventEndDateTime = new Date(YYYY,MM-1,DD,HH,MI,SS);
      var p_eventEndDateTime = Date.parse(eventEndDateTime);

      if( p_eventDateTime > p_today )
      {         // Event will start in future - we have reached current moment in time.
         break; // EXIT POINT
      }

      if( p_eventEndDateTime < p_today )  // Event should have ended by now.
      {
         currentEventId++;
         continue;
      }

      // Event should have started in past,
      // media should be playing right now.
      var l_id = eventTags[currentEventId].getAttribute('related_id');
      var l_date = eventTags[currentEventId].getAttribute('date');
      var l_time = eventTags[currentEventId].getAttribute('time');
      var l_x = eventTags[currentEventId].getAttribute('position_x');
      var l_y = eventTags[currentEventId].getAttribute('position_y');
      var l_width = eventTags[currentEventId].getAttribute('width');
      var l_height = eventTags[currentEventId].getAttribute('height');
      var l_related_name = eventTags[currentEventId].getAttribute('related_name');
      var l_url = l_width+'x'+l_height+'/'+l_related_name;

      startMedia( l_id,l_url,l_date,l_time,l_x,l_y,l_width,l_height );

      currentEventId++;
   }

   nextEvent();
}

</script>
</body>
</html>
